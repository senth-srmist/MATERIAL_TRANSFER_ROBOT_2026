version: '2.2'

services:
  material-transfer-robot:
    environment:
      # CUDA environment variables for mounted host CUDA (ARM64 only)
      - CUDA_HOME=/usr/local/cuda
      - CUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda
      - PATH=/usr/local/cuda/bin:${PATH}
      - CUDA_INCLUDE_DIRS=/usr/local/cuda/include
      - CUDA_CUDART_LIBRARY=/usr/local/cuda/lib64/libcudart.so
      # CRITICAL: Put Tegra EGL FIRST in library path so it takes precedence
      - LD_LIBRARY_PATH=/usr/lib/aarch64-linux-gnu/tegra-egl:/usr/lib/aarch64-linux-gnu/tegra:/usr/local/cuda/lib64:${LD_LIBRARY_PATH}
      # EGL/Display variables for ARM64
      - __NV_PRIME_RENDER_OFFLOAD=1
      - __GLX_VENDOR_LIBRARY_NAME=nvidia
      - __EGL_VENDOR_LIBRARY_DIRS=/usr/lib/aarch64-linux-gnu/tegra-egl
      # CRITICAL: Force device-based EGL (not X11)
      - EGL_PLATFORM=device
      - __EGL_DEVICE_INDEX=0
      # Unset DISPLAY to force headless/device EGL
      - DISPLAY=
      # CycloneDDS for cross-device ROS2 communication
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - ROS_DOMAIN_ID=42
      - CYCLONEDDS_URI=file:///workspace/cyclonedds.xml
    volumes:
      # Mount host CUDA installation (ARM64/Jetson only)
      - /usr/local/cuda:/usr/local/cuda:ro
      # Mount host Tegra CUDA runtime libraries (ARM64/Jetson only)
      - /usr/lib/aarch64-linux-gnu/tegra:/usr/lib/aarch64-linux-gnu/tegra:ro
      - /usr/lib/aarch64-linux-gnu/tegra-egl:/usr/lib/aarch64-linux-gnu/tegra-egl:ro
      - /usr/lib/aarch64-linux-gnu/dri:/usr/lib/aarch64-linux-gnu/dri:ro
      # Mount nvidia EGL vendor config
      - /usr/share/glvnd/egl_vendor.d:/usr/share/glvnd/egl_vendor.d:ro
      # Additional device access for Jetson
    devices:
      - /dev/nvhost-ctrl
      - /dev/nvhost-ctrl-gpu
      - /dev/nvhost-prof-gpu
      - /dev/nvmap
      - /dev/nvhost-gpu
      - /dev/nvhost-as-gpu
      - /dev/nvhost-ctxsw-gpu
      - /dev/nvhost-dbg-gpu
      - /dev/nvhost-sched-gpu
      - /dev/nvhost-tsg-gpu
      - /dev/dri
    group_add:
      - "995"
